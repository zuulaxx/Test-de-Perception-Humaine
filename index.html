<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test de Perception Humaine</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #f1f1f1, #e2e2e2);
      color: #333;
      padding: 40px;
      text-align: center;
    }

    h1 {
      font-size: 36px;
      color: #2c3e50;
      margin-bottom: 30px;
    }

    section {
      margin: 40px 0;
      padding: 25px;
      background-color: #ffffff;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    #circle {
      width: 100px;
      height: 100px;
      margin: 30px auto;
      border-radius: 50%;
      background-color: red;
    }

    input[type=range] {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      background: #ecf0f1;
      border: 1px solid #bdc3c7;
      border-radius: 8px;
      outline: none;
      height: 20px;
    }

    input[type=range]:focus {
      background: #d5dbdb;
    }

    .warning {
      color: #e74c3c;
      font-weight: bold;
      font-size: 16px;
    }

    .audibility {
      font-size: 1.2em;
      font-weight: bold;
      color: #34495e;
      margin-top: 15px;
    }

    .sound-control {
      margin-top: 20px;
    }

    button {
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin: 5px;
    }

    button:hover {
      background-color: #2980b9;
    }

    #resetButton {
      background-color: #e74c3c;
    }

    #resetButton:hover {
      background-color: #c0392b;
    }

    .card {
      display: inline-block;
      width: 45%;
      vertical-align: top;
      margin: 20px 2%;
    }

    /* Small screen adjustments */
    @media (max-width: 768px) {
      .card {
        width: 100%;
      }

      h1 {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>

  <h1>Test de Perception Humaine</h1>

  <div class="card">
    <section id="screenInfo">
      <h2>Infos :</h2>
      <p>Hz détectés de l'écran : <span id="screenHz">Calcul en cours...</span></p>
      <p>Ping en temps réel : <span id="pingTime">N/A</span></p>
    </section>
  </div>

  <!-- Test FPS -->
  <div class="card">
    <section id="fpsTest">
      <h2>Perception Visuelle (Clignotement LED)</h2>
      <p>Ajustez la fréquence du clignotement de la LED.</p>
      <div id="circle"></div>
      <br/>
      <label for="fpsSlider">Fréquence (Hz) :</label>
      <input type="range" min="0" max="240" value="1" step="1" id="fpsSlider" oninput="updateTargetHz(this.value)">
      <span id="fpsValue">1 Hz</span>
      <p id="visualLimitMsg" class="warning"></p>
    </section>
  </div>

  <!-- Test Audition -->
  <div class="card">
    <section id="audioTest">
      <h2>Test d'Audition (Hz)</h2>
      <p>⚠️ L'humain entend généralement entre 20 Hz et 20 000 Hz.</p>
      <label for="freqSlider">Fréquence :</label>
      <!-- Précision de la barre audio sans décimales dans l'affichage -->
      <input type="range" min="10" max="20000" value="20" step="1" id="freqSlider" oninput="updateFrequencyFromSlider(this.value)">
      <span id="freqValue">20 Hz</span>
      <div class="audibility">
        Audibilité estimée : <span id="audibilityPercentage">100%</span>
      </div>
      <div class="sound-control">
        <button onclick="startSound()">Jouer</button>
        <button onclick="stopSound()">Stop</button>
      </div>
    </section>
  </div>

  <section>
    <button id="resetButton" onclick="resetAll()">Réinitialiser</button>
  </section>

  <script>
    let audioCtx, oscillator;
    let circle = document.getElementById("circle");
    let lastToggleTime = performance.now();
    let visible = true;
    let targetHz = 1;
    let currentAudioHz = 20;
    let visualMsg = document.getElementById("visualLimitMsg");
    let screenHz = 60;  // Valeur de base, sera mise à jour

    // Fonction d'animation de la LED
    function animateCircle(timestamp) {
      let interval = 1000 / (targetHz * 2); // demi-période en ms
      if (timestamp - lastToggleTime >= interval) {
        visible = !visible;
        circle.style.backgroundColor = visible ? "red" : "#f5f5f5";
        lastToggleTime = timestamp;
      }
      requestAnimationFrame(animateCircle);
    }

    requestAnimationFrame(animateCircle);

    function updateTargetHz(value) {
      targetHz = parseInt(value);
      document.getElementById("fpsValue").innerText = value + " Hz";

      if (targetHz >= 60) {
        visualMsg.textContent = "⚠️ Au-delà de 60 Hz, il est difficile pour l’œil humain de percevoir un clignotement.";
      } else {
        visualMsg.textContent = "";
      }
    }

    function updateFrequencyFromSlider(value) {
      currentAudioHz = parseInt(value);  // Changement pour arrondir à l'entier
      document.getElementById("freqValue").innerText = value + " Hz";
      updateAudibilityPercentage(currentAudioHz);  // Mettre à jour l'audibilité

      if (oscillator) {
        oscillator.frequency.setValueAtTime(currentAudioHz, audioCtx.currentTime);
      }
    }

    function startSound() {
      stopSound();
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      oscillator = audioCtx.createOscillator();
      oscillator.type = "sine";
      oscillator.frequency.setValueAtTime(currentAudioHz, audioCtx.currentTime);
      oscillator.connect(audioCtx.destination);
      oscillator.start();
    }

    function stopSound() {
      if (oscillator) {
        oscillator.stop();
        oscillator.disconnect();
        oscillator = null;
      }
    }

    function resetAll() {
      updateTargetHz(1);
      document.getElementById("fpsSlider").value = 1;
      updateFrequencyFromSlider(20);
      document.getElementById("freqSlider").value = 20;
      stopSound();
    }

    // Détection fréquence écran
    let frameTimes = [];
    function detectRefreshRate() {
      const now = performance.now();
      while (frameTimes.length > 0 && now - frameTimes[0] > 1000) {
        frameTimes.shift();
      }
      frameTimes.push(now);
      screenHz = frameTimes.length;
      document.getElementById("screenHz").innerText = screenHz + " Hz";

      // Calcul du ping en temps réel
      const pingStart = performance.now();
      setTimeout(() => {
        const pingEnd = performance.now();
        const ping = (pingEnd - pingStart).toFixed(2);
        document.getElementById("pingTime").innerText = ping + " ms";
      }, 50);

      requestAnimationFrame(detectRefreshRate);
    }

    requestAnimationFrame(detectRefreshRate);

    // Calcul de l'audibilité
    function updateAudibilityPercentage(freq) {
      let percentage;

      if (freq >= 20000) {
        percentage = 10;  // Très difficile à entendre pour presque tout le monde
      } else if (freq >= 15000) {
        percentage = 30;
      } else if (freq >= 10000) {
        percentage = 60;
      } else if (freq >= 5000) {
        percentage = 80;
      } else if (freq >= 1000) {
        percentage = 90;
      } else if (freq >= 20) {
        percentage = 100;  // L'audition de ces fréquences est très bonne
      } else {
        percentage = 10;  // En dessous de 20 Hz, très peu de personnes peuvent entendre
      }

      document.getElementById("audibilityPercentage").innerText = percentage + "%";
    }
  </script>
</body>
</html>
